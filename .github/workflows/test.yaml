name: main

on:
  push:
    branches:
      - CI
    paths:
      - ".secrets/**/*.yaml"
      - "_setup/sealedsecret-cert.pem"
      - ".github/workflows/test.yaml"
      - ".github/scripts/generate_sealedsecrets.sh"
    tags-ignore:
      - flux-*

env:
  DEBIAN_FRONTEND: "noninteractive"

jobs:
  main:
    runs-on:
      - self-hosted

    if: "!contains(github.event.head_commit.message, '[ci-skip]')"

    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.ACCESS_TOKEN }}

      - name: Unlock secrets
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: |
          echo "$GIT_CRYPT_KEY" | base64 -d > ./git-crypt-key
          git-crypt unlock ./git-crypt-key
          rm ./git-crypt-key

      - uses: jitterbit/get-changed-files@v1
        id: changed_files
        with:
          format: 'csv'

      - name: Store changed and removed files
        run: |
          echo "${{ steps.files.outputs.added_modified }}"
          mapfile -d ',' -t added_modified_files < <(printf '%s,' '${{ steps.files.outputs.added_modified }}')
          for added_modified_file in "${added_modified_files[@]}"; do
            echo "${changed_file}" >> /tmp/added_modified
          done

      - name: Test
        run: |
          cat /tmp/added_modified
