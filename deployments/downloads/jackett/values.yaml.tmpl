---
controllerType: deployment

podAnnotations:
  configmap.reloader.stakater.com/reload: "jackett-vpn"
  secret.reloader.stakater.com/reload: "jackett-openvpn"
  replicas-max: "1"

service:
  port:
    port: 9117

env:
  TZ: "Europe/Amsterdam"

persistence:
  config:
    enabled: true
    existingClaim: config-jackett-0
  shared:
    enabled: true
    emptyDir: true

ingress:
  enabled: true
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: bjws-lan-ca-issuer
  hosts:
    - host: jackett.{{ (datasource "cluster-vars").domain.internal }}
      paths:
        - path: /
  tls:
    - secretName: tls.jackett
      hosts:
        - jackett.{{ (datasource "cluster-vars").domain.internal }}

resources:
  requests:
    memory: "256M"
  limits:
    memory: "512M"

additionalVolumeMounts:
  - mountPath: /entrypoint.sh
    name: custom-scripts
    subPath: entrypoint.sh

additionalVolumes:
  - name: custom-scripts
    configMap:
      name: jackett-custom-scripts
      defaultMode: 511

addons:
  vpn:
    enabled: true
    type: wireguard

    wireguard:
      image:
        repository: linuxserver/wireguard
        tag: version-v1.0.20200827

    imagePullPolicy: IfNotPresent

    configFile: {{- (datasource "jackett").vpn.config | strings.Indent 6 | printf " |\n%v" }}
    scripts:
      up:  |-
        #!/bin/bash
        INTERFACE=$1
        DEFAULTROUTE=$(ip route | grep default | awk '{print $3}')

        declare -a EXCLUDEDNETWORKS=(
          "{{ (datasource "cluster-vars").networks.k8s_cluster }}"
          "{{ (datasource "cluster-vars").networks.k8s_services }}"
          "{{ (datasource "cluster-vars").networks.management_lan }}"
        )

        iptables -F OUTPUT

        for entry in "${EXCLUDEDNETWORKS[@]}"
        do
          ip route add "$entry" via "$DEFAULTROUTE"
          iptables -A OUTPUT -d "$entry" -j ACCEPT
        done

        iptables -A OUTPUT ! -o "$INTERFACE" -m mark ! --mark $(wg show "$INTERFACE" fwmark) -m addrtype ! --dst-type LOCAL -j REJECT
        echo "connected" > /shared/vpnstatus

      down:  |-
        #!/bin/bash
        INTERFACE=$1
        DEFAULTROUTE=$(ip route | grep default | awk '{print $3}')

        declare -a EXCLUDEDNETWORKS=(
          "{{ (datasource "cluster-vars").networks.k8s_cluster }}"
          "{{ (datasource "cluster-vars").networks.k8s_services }}"
          "{{ (datasource "cluster-vars").networks.management_lan }}"
        )

        iptables -F OUTPUT

        for entry in "${EXCLUDEDNETWORKS[@]}"
        do
          ip route del "$entry" via "$DEFAULTROUTE"
          iptables -D OUTPUT -d "$entry" -j ACCEPT
        done

        iptables -D OUTPUT ! -o "$INTERFACE" -m mark ! --mark $(wg show "$INTERFACE" fwmark) -m addrtype ! --dst-type LOCAL -j REJECT
        echo "disconnected" > /shared/vpnstatus

    env:
      TZ: "Europe/Amsterdam"

    livenessProbe:
      exec:
        command:
        - sh
        - -c
        - curl -s https://am.i.mullvad.net/country | grep "^Belgium$"
      initialDelaySeconds: 30
      periodSeconds: 60
      failureThreshold: 1
