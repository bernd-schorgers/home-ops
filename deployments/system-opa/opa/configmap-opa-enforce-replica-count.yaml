---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opa-enforce-replica-count
  namespace: system-opa
  labels:
    openpolicyagent.org/policy: rego
data:
  enforce-replica-count.rego: |
    package kubernetes.admission
    replicas = input.request.object.spec.replicas
    operations = {"CREATE", "UPDATE"}
    controller = {"Deployment", "StatefulSet"}

    # Get the minimum limit (if any) from the deployment's namespace annotation
    minimum = to_number(input.request.object.metadata.annotations["replicas-min"])
    # Get the maximum limit (if any) from the deployment's namespace annotation
    maximum = to_number(input.request.object.metadata.annotations["replicas-max"])

    deployment_name = input.request.object.metadata.name

    deny[msg]{
      operations[input.request.operation]
      controller[input.request.kind.kind]
      # Evaluate the requested replica count against the one defined in the namespace annotation
      replicas < minimum
      msg := sprintf("The %v %v could not be created/updated because it requests %v replicas which is less than the minimum %v",[input.request.kind.kind,deployment_name,replicas,minimum])
    }

    deny[msg]{
      operations[input.request.operation]
      controller[input.request.kind.kind]
      # Evaluate the requested replica count against the one defined in the namespace annotation
      replicas > maximum
      msg := sprintf("The %v %v could not be created/updated because it requests %v replicas which is more than the maximum %v",[input.request.kind.kind,deployment_name,replicas,maximum])
    }
