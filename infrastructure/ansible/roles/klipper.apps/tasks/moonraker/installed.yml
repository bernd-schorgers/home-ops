---
- name: Ensure moonraker dependencies are installed
  ansible.builtin.import_tasks: "dependencies.yml"

- name: Check if moonraker.service exists
  ansible.builtin.stat:
    path: /etc/systemd/system/moonraker.service
  register: var_moonrakerservice

- name: Stop moonraker.service if service exists
  ansible.builtin.systemd:
    name: moonraker.service
    state: stopped
  become: true
  changed_when: false
  when: var_moonrakerservice.stat.exists

- name: git checkout moonraker
  ansible.builtin.git:
    repo: 'https://github.com/Arksine/moonraker.git'
    dest: "{{moonraker_install_path}}"
    version: "{{moonraker_version}}"
  register: var_moonraker_git

- name: Update moonraker virtualenv
  when: var_moonraker_git.changed
  block:
    - name: Remove existing virtualenv
      ansible.builtin.file:
        path: "{{moonraker_venv_path}}"
        state: absent

    - name: Install moonraker-env
      ansible.builtin.pip:
        virtualenv: "{{moonraker_venv_path}}"
        virtualenv_python: python3
        requirements: "{{moonraker_install_path}}/scripts/moonraker-requirements.txt"

- name: Ensure group "moonraker-admin" exists
  become: true
  ansible.builtin.group:
    name: moonraker-admin
    state: present
  register: moonraker_admin_group

- name: Detect polkit version if any
  ansible.builtin.shell:
    cmd: set -o pipefail && pkaction --version  2>&1 | grep -Po "(\d+\.?\d*)"
  register: polkit_check
  check_mode: false
  changed_when: false
  failed_when: polkit_check.rc != 0 and polkit_check.rc != 127

- name: Create polkit legacy rules file
  become: true
  ansible.builtin.template:
    src: templates/moonraker/10-moonraker.pkla.j2
    dest: /etc/polkit-1/localauthority/50-local.d/10-moonraker.pkla
    mode: 0644
    force: true
  when:
    - polkit_check.rc != 127
    - (polkit_check.stdout | trim) == "0.105"

- name: Create polkit non-legacy rules file
  become: true
  vars:
    moonraker_admin_gid: moonraker_admin_group.gid
  ansible.builtin.template:
    src: templates/moonraker/moonraker.rules.j2
    dest: /etc/polkit-1/rules.d/moonraker.rules
    mode: 0644
    force: true
  when:
    - polkit_check.rc != 127
    - (polkit_check.stdout | trim) != "0.105"

- name: Create moonraker systemd file
  ansible.builtin.template:
    src: templates/moonraker/moonraker.service.j2
    dest: /etc/systemd/system/moonraker.service
    mode: 0644
    force: true
  become: true

- name: Restart moonraker
  become: true
  ansible.builtin.systemd:
    name: moonraker.service
    state: restarted
    enabled: true
    daemon_reload: true
  changed_when: false
