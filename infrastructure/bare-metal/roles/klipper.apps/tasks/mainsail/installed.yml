---
- name: Install mainsail dependencies
  become: true
  ansible.builtin.package:
    name:
      - nginx
    state: present

- name: Check if nginx.service exists
  ansible.builtin.stat:
    path: /lib/systemd/system/nginx.service
  register: var_nginxservice

- name: Stop nginx.service if service exists
  ansible.builtin.systemd:
    name: nginx.service
    state: stopped
  become: true
  changed_when: false
  when: var_nginxservice.stat.exists

- name: Copy mainsail site configuration
  ansible.builtin.template:
    src: mainsail/mainsail.j2
    dest: /etc/nginx/sites-available/mainsail
    force: true
  become: true

- name: Make sure default site is disabled
  become: true
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: Enable mainsail site
  become: true
  ansible.builtin.file:
    src: /etc/nginx/sites-available/mainsail
    dest: /etc/nginx/sites-enabled/mainsail
    state: link

- name: Ensure {{mainsail_install_path}} exists
  ansible.builtin.file:
    path: "{{mainsail_install_path}}"
    state: directory

- name: Download and extract mainsail httpdocs
  ansible.builtin.unarchive:
    remote_src: yes
    src: https://github.com/mainsail-crew/mainsail/releases/{{mainsail_version}}/download/mainsail.zip
    dest: "{{mainsail_install_path}}"

- name: Restart nginx
  become: true
  ansible.builtin.systemd:
    name: nginx.service
    state: restarted
    enabled: true
    daemon_reload: true
  changed_when: false
