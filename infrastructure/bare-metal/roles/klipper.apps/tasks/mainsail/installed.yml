---
- name: Ensure mainsail dependencies are installed
  ansible.builtin.import_tasks: "dependencies.yml"

- name: Check if nginx.service exists
  ansible.builtin.stat:
    path: /lib/systemd/system/nginx.service
  register: var_nginxservice

- name: Stop nginx.service if service exists
  ansible.builtin.systemd:
    name: nginx.service
    state: stopped
  become: true
  changed_when: false
  when: var_nginxservice.stat.exists

- name: Copy mainsail site configuration
  ansible.builtin.template:
    src: mainsail/mainsail.j2
    dest: /etc/nginx/conf.d/mainsail.conf
    force: true
  become: true

- name: Ensure {{mainsail_install_path}} exists
  become: true
  ansible.builtin.file:
    path: "{{mainsail_install_path}}"
    state: directory
    owner: "{{ mainsail_nginx_user }}"
    mode: 0755

- name: Download and extract mainsail httpdocs
  become: true
  ansible.builtin.unarchive:
    remote_src: yes
    src: https://github.com/mainsail-crew/mainsail/releases/{{mainsail_version}}/download/mainsail.zip
    dest: "{{mainsail_install_path}}"
    owner: "{{ mainsail_nginx_user }}"

- name: Restart nginx
  become: true
  ansible.builtin.systemd:
    name: nginx.service
    state: restarted
    enabled: true
    daemon_reload: true
  changed_when: false
