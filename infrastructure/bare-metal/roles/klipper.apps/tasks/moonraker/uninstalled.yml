---
- name: Check if moonraker.service exists
  ansible.builtin.stat:
    path: /etc/systemd/system/moonraker.service
  register: var_moonrakerservice

- name: Stop moonraker.service if service exists
  ansible.builtin.systemd:
    name: moonraker.service
    state: stopped
    enabled: false
  become: true
  changed_when: false
  when: var_moonrakerservice.stat.exists

- name: Remove moonraker installation
  ansible.builtin.file:
    path: "{{moonraker_install_path}}"
    state: absent

- name: Remove moonraker virtualenv
  ansible.builtin.file:
    path: "{{moonraker_venv_path}}"
    state: absent

- name: Ensure group "moonraker-admin" is absent
  become: true
  ansible.builtin.group:
    name: moonraker-admin
    state: absent

- name: Remove polkit legacy rules file
  become: true
  ansible.builtin.file:
    path: /etc/polkit-1/localauthority/50-local.d/10-moonraker.pkla
    state: absent

- name: Remove polkit non-legacy rules file
  become: true
  ansible.builtin.file:
    path: /etc/polkit-1/rules.d/moonraker.rules
    state: absent

- name: Remove moonraker systemd unit
  ansible.builtin.file:
    path: /etc/systemd/system/moonraker.service
    state: absent
  become: true

- name: Reload systemd daemons
  become: true
  ansible.builtin.systemd:
    daemon_reload: true
  changed_when: false
