---
config:
  domain_name: "bjw-s.tech"

  zones:
    local:
      description: Local router zone
      local_zone: true
      firewall:
        default:
          default: drop
          rules:
            - accept_ntp: null
            - accept_dhcp: null
        fromZones:
          - zones:
              - lan
            default: drop
            rules:
              - accept_ssh: null
              - accept_ntp: null
              - accept_dhcp: null
          - zones:
              - trusted
              - wg_trusted
            default: drop
            rules:
              - accept_icmp: null
              - accept_ssh: null
              - accept_ntp: null
              - accept_dhcp: null
              - accept_igmp: null
              - accept_mdns: null
              - accept_vyos_api: null
              - accept_discovery_from_sonos_players: null
              - accept_discovery_from_sonos_controllers: null
          - zones:
              - iot
            default: drop
            rules:
              - accept_ssh: null
              - accept_ntp: null
              - accept_dhcp: null
              - accept_igmp: null
              - accept_mdns: null
              - accept_discovery_from_sonos_players: null
              - accept_discovery_from_sonos_controllers: null
          - zones:
              - servers
            default: drop
            rules:
              - accept_icmp: null
              - accept_ntp: null
              - accept_dhcp: null
              - accept_bgp: null
              - accept_tftp: null
              - accept_prometheus_from_k8s_nodes: null
          - zones:
              - wan
            default: drop
            rules:
              - accept_wireguard: null
          - zones:
              - guest
            default: drop
            rules:
              - accept_dhcp: null

    wan:
      interface: eth0
      firewall:
        default:
          default: accept
          defaultLog: false
          rules: []
        fromZones:
          - zones:
              - video
            default: drop
            defaultLog: false
            rules: []

    lan:
      interface: eth1
      dhcp:
        name_server: ${address_book.services.vyos_dnsdist.ipv4_addr}
      firewall:
        default:
          default: drop
          rules: []

        fromZones:
          - zones:
              - trusted
              - wg_trusted
            default: accept
            defaultLog: false
            rules: []
          - zones:
              - servers
            default: drop
            defaultLog: false
            rules:
              - accept_icmp: null

    rescue:
      interface: eth2
      dhcp:
        name_server: ${cidrhost(networks["rescue"], 1)}

    servers:
      interface: eth1.10
      dhcp:
        domain_name: bjw-s.tech
        name_server: ${address_book.services.vyos_dnsdist.ipv4_addr}
      firewall:
        default:
          default: drop
          rules: []

        fromZones:
          - zones:
              - trusted
              - wg_trusted
              - services
            default: accept
            defaultLog: false
            rules:
              - accept_icmp: null
          - zones:
              - wan
            default: drop
            rules:
              - accept_ingress_from_cloudflare: null
          - zones:
              - lan
            default: drop
            rules:
              - accept_icmp: null
          - zones:
              - iot
            default: drop
            rules:
              - accept_nas_smb_from_scanners: null
              - accept_plex_from_plex_clients: null
              - accept_jellyfin_from_jellyfin_clients: null
              - accept_mqtt_from_mqtt_clients: null
              - accept_mqtt_from_esp: null
              - accept_k8s_ingress_from_sonos_players: null
              - accept_k8s_ingress_from_ereaders: null
              - accept_k8s_ingress_from_wall_displays: null
              - accept_k8s_ingress_from_allowed_devices: null
              - accept_vector_journald_from_allowed_devices: null
          - zones:
              - local
            default: drop
            rules:
              - accept_bgp: null
              - accept_k8s_api: null
              - accept_dns: null

    trusted:
      interface: eth1.20
      dhcp:
        domain_name: bjw-s.tech
        name_server: ${address_book.services.vyos_dnsdist.ipv4_addr}
      firewall:
        default:
          default: drop
          rules: []
        fromZones:
          - zones:
              - local
            default: drop
            rules:
              - accept_igmp: null
              - accept_mdns: null
              - accept_discovery_from_sonos_players: null
          - zones:
              - wg_trusted
            default: accept
            defaultLog: false
            rules: []
          - zones:
              - iot
            default: drop
            rules:
              - accept_udp_from_sonos_players_to_sonos_controllers: null
              - accept_tcp_from_sonos_players_to_sonos_controllers: null
          - zones:
              - servers
            default: drop
            defaultLog: false
            rules:
              - accept_icmp: null

    guest:
      interface: eth1.30
      dhcp:
        name_server: ${address_book.services.vyos_dnsdist.ipv4_addr}
      firewall:
        default:
          default: drop
          rules: []

    iot:
      interface: eth1.40
      dhcp:
        domain_name: bjw-s.tech
        name_server: ${address_book.services.vyos_dnsdist.ipv4_addr}
      firewall:
        default:
          default: drop
          rules: []
        fromZones:
          - zones:
              - trusted
              - wg_trusted
            default: accept
            defaultLog: false
            rules:
              - accept_icmp: null
              - accept_app_control_from_sonos_controllers_tcp: null
              - accept_app_control_from_sonos_controllers_udp: null
          - zones:
              - servers
            default: drop
            rules:
              - accept_icmp: null
              - accept_p1reader_from_k8s_nodes: null
              - accept_adb_from_k8s_nodes: null
              - accept_3d_printer_control_from_k8s_nodes: null
              - accept_k8s_nodes: null
          - zones:
              - local
            default: drop
            rules:
              - accept_igmp: null
              - accept_mdns: null
              - accept_discovery_from_sonos_controllers: null
          - zones:
              - guest
            default: drop
            rules:
              - accept_tcp_printer_from_allowed_devices: null
              - accept_udp_printer_from_allowed_devices: null

    video:
      interface: eth1.50
      dhcp:
        domain_name: bjw-s.tech
        name_server: ${address_book.services.vyos_dnsdist.ipv4_addr}
      firewall:
        default:
          default: drop
          rules: []
        fromZones:
          - zones:
              - trusted
              - wg_trusted
            default: accept
            defaultLog: false
            rules:
              - accept_icmp: null
          - zones:
              - servers
            default: drop
            rules:
              - accept_icmp: null
              - accept_k8s_nodes: null

    wg_trusted:
      interface: wg01
      port: 51820
      peers:
        ipad-bernd:
          ipv4_hostid: 4
          public_key: EYuUoDoCIcSYbnjNyPSsZUcz4Yp032AHWflYlH2V1EM=
        iphone-bernd:
          ipv4_hostid: 2
          public_key: 608IT2YRPTCabLMGnpYfIWhgDnEpLV5IIpYi5J7m3As=
        macbook-bernd:
          ipv4_hostid: 3
          public_key: iWKTc88fDBhqlsAgoCXYvkBdf9wG4YBZ8XTg/+0Ln2I=
      firewall:
        default:
          default: drop
          rules: []
        fromZones:
          - zones:
              - local
            default: drop
            rules:
              - accept_igmp: null
              - accept_mdns: null

    services:
      description: VyOS services zone
      interface: cni-services
      firewall:
        default:
          default: accept
          defaultLog: false
          rules:
            - accept_dns: null
        fromZones:
          - zones:
              - servers
            default: accept
            rules:
              - accept_dns: null
              - accept_k8s_api: null
          - zones:
              - guest
            default: drop
            rules:
              - accept_dns: null
          - zones:
              - wan
            default: drop
            rules: []
