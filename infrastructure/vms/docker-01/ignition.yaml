---
variant: fcos
version: 1.4.0

passwd:
  users:
    - name: serveradmin
      groups:
        - wheel
        - sudo
      ssh_authorized_keys:
        - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMyYn4k4V+myBBl79Nt3t7EZugvz9A+d3ZbKyaP1w7J5"

storage:
  disks:
    - device: /dev/vdb
      wipe_table: false
      partitions:
        - number: 1
          label: var-srv
  filesystems:
    - path: /var/srv
      device: /dev/disk/by-partlabel/var-srv
      format: btrfs
      wipe_filesystem: false
      label: var-srv
      with_mount_unit: true
  directories:
    - path: /var/srv/postgres-14
    - path: /var/mnt/nas/backup
  files:
    - path: /etc/hostname
      mode: 0644
      overwrite: true
      contents:
        inline: ${hostname}
    - path: /etc/environment-secrets
      contents:
        inline: |
          POSTGRES_PASSWORD=${postgres.password}

systemd:
  units:
    - name: var-mnt-nas-backup.mount
      enabled: true
      contents: |
        [Unit]
        Description=Mount /var/mnt/nas/backup
        After=network-online.target
        Wants=network-online.target
        [Mount]
        What=${nas}:/volume1/Backup/
        Where=/var/mnt/nas/backup
        Type=nfs
        [Install]
        WantedBy=multi-user.target

    - name: pod-database.service
      enabled: true
      contents: |
        [Unit]
        Description=Creates a podman pod to run the database services.
        After=network-online.target
        Wants=network-online.target
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=sh -c 'podman pod exists database || podman pod create -n database -p 5432:5432'
        ExecStop=sh -c 'podman pod exists database && podman pod rm --force database'
        [Install]
        WantedBy=multi-user.target

    - name: container-postgresql.service
      enabled: true
      contents: |
        [Unit]
        Description=postgres 14.
        Wants=network.target
        After=network-online.target pod-database.service
        Requires=pod-database.service
        [Service]
        Environment=PODMAN_SYSTEMD_UNIT=%n
        EnvironmentFile=/etc/environment-secrets
        Restart=on-failure
        TimeoutStopSec=70
        ExecStartPre=/bin/rm -f %t/container-postgresql.pid %t/container-postgresql.ctr-id
        ExecStart=/bin/podman run \
            --conmon-pidfile %t/container-postgresql.pid \
            --cidfile %t/container-postgresql.ctr-id \
            --cgroups=no-conmon -d --replace \
            --rm \
            --read-only \
            --pod=database \
            --name=postgres \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_INITDB_ARGS="--encoding='UTF8' --lc-collate='C' --lc-ctype='C'" \
            -e POSTGRES_PASSWORD=$${POSTGRES_PASSWORD} \
            -v /var/srv/postgres-14:/var/lib/postgresql/data:z \
            ${postgres.image} \
            -c listen_addresses='*'
        ExecStop=/usr/bin/podman stop --ignore --cidfile %t/container-postgresql.ctr-id -t 10
        ExecStopPost=/usr/bin/podman rm --ignore -f --cidfile %t/container-postgresql.ctr-id
        PIDFile=%t/container-postgresql.pid
        Type=forking
        [Install]
        WantedBy=multi-user.target

    - name: container-postgresql-backup.service
      enabled: true
      contents: |
        [Unit]
        Description=postgres backup 14.
        Wants=network.target
        After=network-online.target container-postgresql.service
        Requires=pod-database.service container-postgresql.service
        [Service]
        Environment=PODMAN_SYSTEMD_UNIT=%n
        EnvironmentFile=/etc/environment-secrets
        Restart=on-failure
        TimeoutStopSec=70
        ExecStartPre=/bin/rm -f %t/container-postgresql-backup.pid %t/container-postgresql-backup.ctr-id
        ExecStart=/bin/podman run \
            --conmon-pidfile %t/container-postgresql-backup.pid \
            --cidfile %t/container-postgresql-backup.ctr-id \
            --cgroups=no-conmon -d --replace \
            --rm \
            --read-only \
            --pod=database \
            --name=postgres-backup \
            --user ${postgres_backup.run_as.user}:${postgres_backup.run_as.group} \
            -e POSTGRES_HOST=127.0.0.1 \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=$${POSTGRES_PASSWORD} \
            -e POSTGRES_DB="${join(",", postgres_backup.databases)}" \
            -v /mnt/nas/backup/Databases/postgresql:/backups \
            ${postgres_backup.image}
        ExecStop=/usr/bin/podman stop --ignore --cidfile %t/container-postgresql-backup.ctr-id -t 10
        ExecStopPost=/usr/bin/podman rm --ignore -f --cidfile %t/container-postgresql-backup.ctr-id
        PIDFile=%t/container-postgresql-backup.pid
        Type=forking
        [Install]
        WantedBy=multi-user.target
