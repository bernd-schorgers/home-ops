---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: vpn
  namespace: vpn
spec:
  interval: 5m
  chart:
    spec:
      chart: /k8s/charts/kah-common-chart/
      sourceRef:
        kind: GitRepository
        name: home-ops
        namespace: flux-system
      interval: 5m
  values:
    image:
      repository: nicolaka/netshoot
      tag: latest
      pullPolicy: Always

    command:
      - /bin/sh
      - -c
      - sleep infinity

    nameOverride: "wireguard"

    service:
      main:
        enabled: false

    probes:
      liveness:
        enabled: false
      readiness:
        enabled: false
      startup:
        enabled: false

    addons:
      vpn:
        enabled: true
        type: wireguard

        wireguard:
          image:
            repository: ghcr.io/k8s-at-home/wireguard
            tag: v1.0.20210914
            pullPolicy: IfNotPresent

        securityContext:
          privileged: true
          runAsUser: 568
          runAsGroup: 568

        env:
          TZ: "Europe/Amsterdam"
          IPTABLES_BACKEND: nft
          KILLSWITCH: "false"

        configFileSecret: wireguard-vpnconfig

        resources:
          requests:
            cpu: "0.001"
            memory: 64Mi
          limits:
            memory: 128Mi

        networkPolicy:
          enabled: true

          egress:
            - to:
                - ipBlock:
                    cidr: 0.0.0.0/0
              ports:
                # VPN traffic port - change if your provider uses a different port
                - port: ${VPN_PORT}
                  protocol: UDP
            - to:
                # Allow traffic within K8S - change if your K8S cluster uses a different CIDR
                - ipBlock:
                    cidr: ${NETWORK_K8S_CLUSTER_CIDR}
                - ipBlock:
                    cidr: ${NETWORK_K8S_SERVICE_CIDR}
