---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: zalando-postgres-ui
  namespace: database
spec:
  interval: 30m
  chart:
    spec:
      chart: postgres-operator-ui
      version: 1.10.0
      sourceRef:
        kind: HelmRepository
        name: zalando-postgres-operator-ui
        namespace: flux-system
      interval: 5m
  # https://github.com/zalando/postgres-operator/blob/master/charts/postgres-operator/values.yaml
  values:
    envs:
      # IMPORTANT: While operator chart and UI chart are independent, this is the interface between
      # UI and operator API. Insert the service name of the operator API here!
      appUrl: "https://zalando.bjw-s.dev"
      operatorApiUrl: "http://zalando-postgres-postgres-operator.database.svc.cluster.local:8080"
      operatorClusterNameLabel: "cluster-name"
      resourcesVisible: "False"
      targetNamespace: "database"
      teams:
        - "bjw-s"

    extraEnvs:
      - name: WALE_S3_ENDPOINT
        value: http+path://s3.bjw-s.dev
      - name: AWS_ENDPOINT
        value: http://s3.bjw-s.dev
      - name: AWS_S3_FORCE_PATH_STYLE
        value: "true"
      - name: SPILO_S3_BACKUP_BUCKET
        value: zalando-postgres
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: zalando-postgres-pod-secrets
            key: AWS_ACCESS_KEY_ID
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: zalando-postgres-pod-secrets
            key: AWS_SECRET_ACCESS_KEY
      - name: AWS_DEFAULT_REGION
        value: us-east-1

    ingress:
      enabled: true
      ingressClassName: "nginx"
      annotations:
        nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
      hosts:
        - host: &host "zalando.bjw-s.dev"
          paths:
            - "/"
      tls:
        - hosts:
            - *host
