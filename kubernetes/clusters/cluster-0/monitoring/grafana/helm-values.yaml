---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: grafana
spec:
  values:
    admin:
      existingSecret: grafana-secrets
      userKey: adminUser
      passwordKey: adminPass

    grafana.ini:
      server:
        root_url: "https://grafana.${CLUSTER_NAME}.${INGRESS_DOMAIN}"

    datasources:
      datasources.yaml:
        datasources:
          - name: Prometheus
            type: prometheus
            url: http://grafana-mimir-nginx.monitoring.svc.cluster.local:80/prometheus
            access: proxy
            isDefault: true
            jsonData:
              httpHeaderName1: X-Scope-OrgID
              alertmanagerUid: 'alertmanager'
            secureJsonData:
              httpHeaderValue1: anonymous

          - name: Loki
            type: loki
            access: proxy
            url: http://loki.monitoring.svc.cluster.local:3100

          - name: Alertmanager
            uid: alertmanager
            type: alertmanager
            access: proxy
            url: http://kube-prometheus-stack-alertmanager.monitoring.svc.cluster.local:9093
            jsonData:
              implementation: 'prometheus'

    ingress:
      enabled: true
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-production
        external-dns.alpha.kubernetes.io/target: ingress.${INGRESS_DOMAIN}
      ingressClassName: nginx
      hosts:
        - "grafana.${CLUSTER_NAME}.${INGRESS_DOMAIN}"
      tls:
        - secretName: grafana-${CLUSTER_NAME}-tls
          hosts:
            - "grafana.${CLUSTER_NAME}.${INGRESS_DOMAIN}"

    resources:
      requests:
        cpu: 23m
        memory: 127M
      limits:
        memory: 219M
