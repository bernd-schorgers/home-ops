<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js latte">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Run a Pod in a VLAN - Home-Ops</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../././assets/css/mdbook-admonish.css">
        <link rel="stylesheet" href="../.././theme/catppuccin.css">
        <link rel="stylesheet" href="../.././theme/catppuccin-highlight.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "macchiato" : "latte";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('latte')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Welcome</li><li class="chapter-item expanded "><a href="../../introduction.html">üëã Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Overview</li><li class="chapter-item expanded "><a href="../../overview/hardware.html">üîß Hardware</a></li><li class="chapter-item expanded "><div>üåê Network</div></li><li class="chapter-item expanded "><a href="../../overview/cloud-services.html">‚òÅÔ∏è Cloud services</a></li><li class="chapter-item expanded affix "><li class="part-title">Home Ops</li><li class="chapter-item expanded "><a href="../../kubernetes/index.html">‚õµ Kubernetes</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../kubernetes/gitops.html">GitOps</a></li><li class="chapter-item "><a href="../../kubernetes/storage.html">Storage</a></li><li class="chapter-item "><a href="../../kubernetes/backups.html">Backups</a></li></ol></li><li class="chapter-item expanded "><a href="../../automation/index.html">Automation</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../automation/terraform/index.html">‚öôÔ∏è Terraform</a></li><li class="chapter-item "><a href="../../automation/ansible/index.html">üöÄ Ansible</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Notes and ramblings</li><li class="chapter-item expanded "><a href="../../notes-ramblings/howto/index.html">How to...</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../notes-ramblings/howto/pod-multihome.html" class="active">Run a Pod in a VLAN</a></li><li class="chapter-item "><a href="../../notes-ramblings/howto/mixed-protocol-service.html">Run a Service with both TCP and UDP</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="latte">Latte (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="frappe">Frapp√©</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="macchiato">Macchiato</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mocha">Mocha</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Home-Ops</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/bjw-s/home-ops" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="run-a-pod-in-a-vlan"><a class="header" href="#run-a-pod-in-a-vlan">Run a Pod in a VLAN</a></h1>
<p>Sometimes you'll want to give a Kubernetes Pod direct access to a VLAN.
This could be for any number of reasons, but the most common reason is for the application to be able to automatically discover devices on that VLAN.</p>
<p>A good example of this would be <a href="https://www.home-assistant.io">Home Assistant</a>. This application has several integrations that rely on being able to discover the hardware devices (e.g. <a href="https://www.sonos.com">Sonos</a> speakers or <a href="https://esphome.io">ESPHome</a> devices).</p>
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#nic-configuration">NIC configuration</a></li>
<li><a href="#multus-configuration">Multus Configuration</a></li>
<li><a href="#networkattachmentdefinition">NetworkAttachmentDefinition</a></li>
<li><a href="#pod-configuration">Pod configuration</a></li>
<li><a href="#app-specific-configuration-home-assistant">App-specific configuration: Home Assistant</a></li>
</ul>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>For a Kubernetes cluster to be able to add additional network interfaces to Pods (this is also known as &quot;multi-homing&quot;) the <a href="https://github.com/k8snetworkplumbingwg/multus-cni">Multus CNI</a> needs to be installed in your cluster.</p>
<div id="admonition-note" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="#admonition-note"></a></p>
</div>
<div>
<p>I use the Helm chart provided by <a href="https://github.com/angelnu/helm-charts/tree/main/charts/apps/multus">@angelnu</a> to install Multus. The reason for using this over the <a href="https://github.com/k8snetworkplumbingwg/multus-cni/blob/master/deployments/multus-daemonset.yml">official deployment method</a> is that it has better support for upgrade/update scenarios.</p>
</div>
</div>
<h2 id="nic-configuration"><a class="header" href="#nic-configuration">NIC configuration</a></h2>
<p>Make sure that the Kubernetes node has a network interface that is connected to the VLAN you wish to connect to.</p>
<div id="admonition-note-1" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="#admonition-note-1"></a></p>
</div>
<div>
<p><a href="../../overview/hardware.html">My nodes</a> only have a single NIC, so I have <a href="https://github.com/bjw-s/home-ops/blob/main/infrastructure/talos/main/talconfig.yaml">set them up</a> so their main interface gets it's IP address over DHCP and a virtual interface connecting to the VLAN. How to do this will depend on your operating system.</p>
</div>
</div>
<h2 id="multus-configuration"><a class="header" href="#multus-configuration">Multus Configuration</a></h2>
<p>My Multus Helm configuration can be found <a href="https://github.com/bjw-s/home-ops/blob/main/kubernetes/main/apps/network/multus/app/helmrelease.yaml">here</a>.</p>
<p>It is important to note that the paths of your CNI plugin binaries / config might differ depending on the Kubernetes distribution you are running. For my <a href="https://www.talos.dev">Talos</a> setup they need to be set to <code>/opt/cni/bin</code> and <code>etc/cni/net.d</code> respectively.</p>
<h2 id="networkattachmentdefinition"><a class="header" href="#networkattachmentdefinition">NetworkAttachmentDefinition</a></h2>
<p>Once the Multus CNI has been installed and configured you can use the <code>NetworkAttachmentDefinition</code> Custom Resource to define the virtual IP addresses that you want to hand out. These need to be free addresses within the VLAN subnet, so it's important to make sure that they do not overlap with your DHCP server range(s).</p>
<pre><code class="language-yaml">{{ #include ../../../../kubernetes/main/apps/home-automation/home-assistant/app/networkattachmentdefinition.yaml }}
</code></pre>
<p>Be sure to check out the <a href="https://github.com/k8snetworkplumbingwg/multus-cni/blob/master/docs/configuration.md">official documentation</a> for more information on how to configure the <code>spec.config</code> field.</p>
<h2 id="pod-configuration"><a class="header" href="#pod-configuration">Pod configuration</a></h2>
<p>Once the NetworkAttachmentDefinition has been loaded it is possible to use it within a Pod. This can be done by setting an annotation on the Pod that references it. Staying with the Home Assistant example (<a href="https://github.com/bjw-s/home-ops/blob/main/kubernetes/main/apps/home-automation/home-assistant/app/helmrelease.yaml">full Helm values</a>), this would be:</p>
<p><code>k8s.v1.cni.cncf.io/networks: macvlan-static-iot-hass</code></p>
<h2 id="app-specific-configuration-home-assistant"><a class="header" href="#app-specific-configuration-home-assistant">App-specific configuration: Home Assistant</a></h2>
<p>In order for Home Assistant to actually use the additional network interface you will need to explicitly enable it instead of relying on automatic network detection.
To do so, navigate to <code>Settings &gt;&gt; System &gt;&gt; Network</code> (this setting is only available to Home Assistant users that have &quot;Advanced mode&quot; enabled in their user profile) and place a checkmark next to the adapters that you wish to use with Home Assistant integrations.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../notes-ramblings/howto/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../notes-ramblings/howto/mixed-protocol-service.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../notes-ramblings/howto/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../notes-ramblings/howto/mixed-protocol-service.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>






        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
